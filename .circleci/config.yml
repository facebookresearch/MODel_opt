version: 2.1

gpu: &gpu
  machine:
    image: ubuntu-2004-cuda-11.4:202110-01
  resource_class: gpu.nvidia.large

commands:
  setup_python:
    parameters:
      python_version:
        type: string
        default: "3.8"
    steps:
      - run:
          name: "Install and set Python 3.8.6"
          command: |
            pyenv install 3.8.6
            pyenv global 3.8.6
      - run:
          name: "Create Virtual environment"
          command: |
            pip install virtualenv
            python -m venv ~/venv
            echo "source ~/venv/bin/activate" >> $BASH_ENV
  install_python_dependencies:
    steps:
      - run:
          name: "Install Python dependencies"
          command: |
            pip install networkx graphviz intervaltree pandas pydot
      - run:
          name: "Install PyTorch 1.13.1 - CUDA 11.3"
          command: |
            pip install torch torchvision torchaudio torchtext --extra-index-url https://download.pytorch.org/whl/nightly/cu113
      - run:
          name: "Install Gurobi Python 9.1.1"
          command: |
            pip install gurobipy==9.1.1
  run_tests_gurobi:
    steps:
      - run:
          name: "Run tests with optimizer=Gurobi"
          command: |
            python -m unittest discover -s tests --pattern "*_test.py"
          # environment:
          #   OLLA_GUROBI_ISV_APP_NAME: $OLLA_GUROBI_ISV_APP_NAME
          #   OLLA_GUROBI_ISV_CODE: $OLLA_GUROBI_ISV_CODE
          #   OLLA_GUROBI_ISV_EXPIRATION: $OLLA_GUROBI_ISV_EXPIRATION
          #   OLLA_GUROBI_ISV_NAME: $OLLA_GUROBI_ISV_NAME

jobs:
  ubuntu_python_3_8_6_cuda_11_4:
    <<: *gpu
    steps:
      - setup_python
      - install_python_dependencies
      - checkout
      - run_tests_gurobi

workflows:
  build-test:
    jobs:
      - ubuntu_python_3_8_6_cuda_11_4:
          name: "Ubuntu | Python 3.8.6 | CUDA 11.3 | Gurobi"
